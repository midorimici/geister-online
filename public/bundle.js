(()=>{"use strict";const t="rgb(30, 30, 30)",e="rgb(200, 0, 0)",n="rgb(0, 0, 200)",i="rgb(150, 150, 150)";var r=function(){function t(t){this.v=t}return t.prototype.val=function(){return this.v},t.prototype.add=function(e){return Array.isArray(e)?new t([e[0]+this.v[0],e[1]+this.v[1]]):new t([e+this.v[0],e+this.v[1]])},t.prototype.mul=function(e){return new t([e*this.v[0],e*this.v[1]])},t.prototype.div=function(e){return new t([this.v[0]/e,this.v[1]/e])},t.prototype.quot=function(e){return new t([Math.floor(this.v[0]/e),Math.floor(this.v[1]/e)])},t}(),o=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return a},a=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(o(arguments[e]));return t},l=function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],i=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};const c=function(){function c(t){var e=document.documentElement.clientWidth,n=document.documentElement.clientHeight;(e<n||n<720)&&(document.getElementById("logo").style.display="none",document.getElementById("info-icon").style.display="none",document.getElementsByTagName("footer")[0].style.display="none");var i=(.9*(e<n?e:n)).toString();t.setAttribute("width",i),t.setAttribute("height",i),this.canvas=t,this.ctx=t.getContext("2d"),this.squareSize=3*t.width/20,this.margin=t.width/20,this.pieceSize=t.width/10,this.piecePath=new Path2D,this.piecePath.moveTo(0,-this.pieceSize/2),this.piecePath.lineTo(-this.pieceSize/2,this.pieceSize/2),this.piecePath.lineTo(this.pieceSize/2,this.pieceSize/2),this.piecePath.closePath(),this.arrowPath=new Path2D,this.arrowPath.moveTo(this.pieceSize/2,this.pieceSize/2),this.arrowPath.lineTo(0,0),this.arrowPath.lineTo(-this.pieceSize/2,this.pieceSize/2),this.arrowPath.moveTo(0,0),this.arrowPath.lineTo(0,this.pieceSize),this.arrowPath.closePath()}return c.prototype.clearCanvas=function(){this.ctx.fillStyle="rgb(240, 227, 206)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},c.prototype.waiting=function(e){this.clearCanvas();var n=this.canvas,i=this.ctx,r=n.width/20;i.fillStyle=t,i.font=r+"px Meiryo","player"===e?i.fillText("対戦相手の入室を待っています...",n.width/2-7.5*r,n.height/2):i.fillText("対戦者が駒を配置するのを待っています...",n.width/2-9.5*r,n.height/2)},c.prototype.waitingPlayer=function(){this.waiting("player")},c.prototype.waitingPlacing=function(){this.waiting("placing")},c.prototype.grid=function(e,n,i){var o=this.ctx,l=this.squareSize;o.strokeStyle=t,o.lineWidth=2,o.beginPath();for(var c=0;c<=i;c++)o.moveTo.apply(o,a(new r(e).add([0,l*c]).val())),o.lineTo.apply(o,a(new r(e).add([l*n,l*c]).val()));for(c=0;c<=n;c++)o.moveTo.apply(o,a(new r(e).add([l*c,0]).val())),o.lineTo.apply(o,a(new r(e).add([l*c,l*i]).val()));o.closePath(),o.stroke()},c.prototype.piece=function(t,e,n){var i=this.ctx,o=new r(e).mul(this.squareSize).add(this.margin+this.squareSize/2).val();i.save(),i.fillStyle=t,i.translate.apply(i,a(o)),n&&i.rotate(Math.PI),i.fill(this.piecePath),i.restore()},c.prototype.button=function(e,n,i){var o=this.ctx;o.fillStyle=i?"rgb(160, 140, 120)":"rgb(200, 180, 160)",o.fillRect.apply(o,a(e,n)),o.font=this.canvas.width/30+"px Meiryo",o.save(),o.textAlign="center",o.textBaseline="middle",o.fillStyle=t,o.fillText.apply(o,a(["OK"],new r(n).div(2).add(e).val())),o.restore()},c.prototype.decidePiecePlace=function(i,r){var a,c;this.clearCanvas();var s=this.ctx,u=this.canvas.width,h=u/40;s.fillStyle=t,s.font=h+"px Meiryo",s.fillText("駒の配置を決めてね（↓自分側　↑相手側）",u/30,u/30),s.fillText("クリック（タップ）で悪いおばけ（赤）と良いおばけ（青）を切り替えるよ",u/30,u/30+2*h);var d=[this.margin+this.squareSize,this.margin+2*this.squareSize];this.grid(d,4,2),this.button([5*u/6,5*u/6],[u/8,u/12],r);try{for(var f=l(i.entries()),p=f.next();!p.done;p=f.next()){var v=o(p.value,2),y=v[0],g=v[1],m=o(y.split(","),2),w=m[0],S=m[1];this.piece("R"===g?e:n,[+w,+S],!1)}}catch(t){a={error:t}}finally{try{p&&!p.done&&(c=f.return)&&c.call(f)}finally{if(a)throw a.error}}},c.prototype.board=function(c,s,u,h,d){var f,p;void 0===d&&(d=!1),this.clearCanvas();var v=this.ctx;this.grid([this.margin,this.margin],6,6);var y=(this.squareSize-this.pieceSize)/2,g=new r([this.squareSize/2,y]).add(this.margin).val();v.save(),v.translate.apply(v,a(g)),v.stroke(this.arrowPath),v.restore(),v.save(),v.translate.apply(v,a(new r(g).add([5*this.squareSize,0]).val())),v.stroke(this.arrowPath),v.restore(),v.save(),v.translate.apply(v,a(new r(g).add([0,5*this.squareSize+this.pieceSize]).val())),v.rotate(Math.PI),v.stroke(this.arrowPath),v.restore(),v.save(),v.translate.apply(v,a(new r(g).add([5*this.squareSize,5*this.squareSize+this.pieceSize]).val())),v.rotate(Math.PI),v.stroke(this.arrowPath),v.restore();try{for(var m=l(c.entries()),w=m.next();!w.done;w=m.next()){var S=o(w.value,2),P=S[0],x=S[1],b="R"===x.color?e:n,z=P.split(",").map((function(t){return+t}));0===s?this.piece(d||0===x.turn?b:i,z,1===x.turn):this.piece(d||1===x.turn?b:i,z,0===x.turn)}}catch(t){f={error:t}}finally{try{w&&!w.done&&(p=m.return)&&p.call(m)}finally{if(f)throw f.error}}var T=this.canvas.width,E=T/40;v.fillStyle=t,v.font=E+"px Meiryo",v.fillText(1===s?h:u,3*T/4,T-E),v.fillText(1===s?u:h,3*T/4,E)},c.prototype.dest=function(t,e,n){var i,o,c=this.ctx;try{for(var s=l(t.coveringSquares(e)),u=s.next();!u.done;u=s.next()){var h=u.value;if(!n.has(String(h))||n.get(String(h)).turn!==n.get(String(e)).turn){var d=new r(h).mul(this.squareSize).add(this.margin+this.squareSize/2).val();c.beginPath(),c.arc.apply(c,a(d,[this.pieceSize/2,0,2*Math.PI])),c.fillStyle="rgb(121, 202, 68)",c.fill()}}}catch(t){i={error:t}}finally{try{u&&!u.done&&(o=s.return)&&o.call(s)}finally{if(i)throw i.error}}},c.prototype.takenPieces=function(t,i){for(var r=this,o=this.ctx,l=this.pieceSize/6,c=this.margin,s=this.squareSize,u=function(t,e){o.save(),o.fillStyle=e,o.translate.apply(o,a(t)),o.scale(1/6,1/6),o.fill(r.piecePath),o.restore()},h=0===i?c+6*s+l:l,d=1===i?c+6*s+l:l,f=0;f<t[0].R;f++)u([(f+1)*l,h],e);for(f=0;f<t[0].B;f++)u([(f+1+t[0].R)*l,h],n);for(f=0;f<t[1].R;f++)u([(f+1)*l,d],e);for(f=0;f<t[1].B;f++)u([(f+1+t[1].R)*l,d],n)},c}(),s=function(){function t(t){this.squareSize=3*t.width/20,this.margin=t.width/20}return t.prototype.getWindowPos=function(t){var e=t.target.getBoundingClientRect();return[t.clientX-e.left,t.clientY-e.top]},t.prototype.chcoord=function(t){return new r(t).add(-this.margin).quot(this.squareSize).val()},t.prototype.getCoord=function(t){return this.chcoord(this.getWindowPos(t))},t.prototype.onArea=function(t,e,n,i,r,o){return n<=t&&t<=n+r&&i<=e&&e<=i+o},t}();const u=function(){function t(t,e){this.color=t,this.turn=e}return t.prototype.coveringSquares=function(t){var e=[[0,1],[0,-1],[-1,0],[1,0]].map((function(e){return new r(t).add(e).val()})).filter((function(t){var e=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return a}(t,2),n=e[0],i=e[1];return 0<=n&&n<=5&&0<=i&&i<=5}));return"B"===this.color&&("0,0"===String(t)?e.push([0,-1]):"5,0"===String(t)&&e.push([5,-1])),e},t}();var h,d,f=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return a},p=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(f(arguments[e]));return t},v=!1,y=document.getElementById("canvas"),g=document.getElementById("game-message"),m=document.getElementById("mute-icon"),w=!0,S=function(){document.getElementById("settings").style.display="none",h=new c(y),v=!0,document.getElementById("game-container").style.display="flex"},P=io("https://geister-online.herokuapp.com"),x=document.getElementById("form");x.addEventListener("submit",(function(t){t.preventDefault();var e=new FormData(x),n={roomId:e.get("room"),role:e.get("role"),name:""===e.get("username")?"名無し":e.get("username")};d=n.role,P.emit("enter room",n)}),!1),P.on("room full",(function(t){document.getElementById("message").innerText="ルーム "+t+" はいっぱいです。対戦者として参加することはできません。"})),P.on("no room",(function(t){document.getElementById("message").innerText="ルーム "+t+" では対戦が行われていません。"})),P.on("wait opponent",(function(){v||S(),h.waitingPlayer()}));for(var b,z=new Map,T=1;T<=4;T++)for(var E=2;E<=3;E++)z.set(T+","+E,"R");var k=function(t){new Audio("./static/sounds/"+t+".wav").play()};P.on("place pieces",(function(){v||S();var t=y.width,e=!1,n=function(){h.decidePiecePlace(z,!e)};n(),b=new s(y),y.onclick=function(i){for(var r=1;r<=4;r++)for(var o=2;o<=3;o++)String(b.getCoord(i))===String([r,o])&&(z.set(r+","+o,"R"===z.get(r+","+o)?"B":"R"),a=Array.from(z.values()),e=a.filter((function(t){return"R"===t})).length===a.filter((function(t){return"B"===t})).length,w||k("select"));var a;b.onArea.apply(b,p(b.getWindowPos(i),[5*t/6,5*t/6,t/8,t/12]))&&(e?(y.onclick=function(){},P.emit("decided place",p(z.entries())),w||k("decide")):w||k("forbid")),n()}})),P.on("wait placing",(function(){v||S(),h.waitingPlacing()})),P.on("game",(function(t,e,n,i,r,o){var a,l=new Map(t);h.board(l,e,i,r),h.takenPieces(o,e),n?(g.innerText="あなたの番です。",w||k("move"),b=new s(y),y.onclick=function(t){var n=b.getCoord(t);if(l.has(String(n))&&l.get(String(n)).turn===e){a=n;var c=Object.values(l.get(String(n))),s=new(u.bind.apply(u,p([void 0],c)));h.board(l,e,i,r),h.dest(s,a,l),h.takenPieces(o,e)}else l.has(String(a))&&(c=Object.values(l.get(String(a))),(s=new(u.bind.apply(u,p([void 0],c)))).coveringSquares(a).some((function(t){return String(t)===String(n)}))&&(l.set(String(n),l.get(String(a))),l.delete(String(a)),w||k("move"),P.emit("move piece",e,a,n))),h.board(l,e,i,r),h.takenPieces(o,e),a=null}):(g.innerText="相手の番です。",y.onclick=function(){})})),P.on("watch",(function(t,e,n,i,r){if("watch"===d){v||S();var o=new Map(t);h.board(o,0,e,n,!0),h.takenPieces(r,0),g.innerText=(0===i?e:n)+" さんの番です。",w||k("move")}})),P.on("tell winner to audience and first",(function(t,e,n,i,r){g.innerText=t+" の勝ち！",w||k("win"),"play"===d&&(y.onclick=function(){h.board(new Map(e),0,n,i,!0),h.takenPieces(r,0),y.onclick=function(){}})})),P.on("tell winner to second",(function(t,e,n,i,r){g.innerText=t+" の勝ち！",w||k("win"),y.onclick=function(){h.board(new Map(e),1,n,i,!0),h.takenPieces(r,1),y.onclick=function(){}}})),P.on("player discon",(function(t){alert(t+"さんの接続が切れました。"),location.reload()})),m.onclick=function(){m.src=w?"./static/svg/volume-up-solid.svg":"./static/svg/volume-mute-solid.svg",m.title=w?"ミュート":"ミュート解除",w=!w};var B=document.getElementById("chat-form"),I=document.getElementById("chat-input"),q=document.getElementById("chat-send-icon");B.addEventListener("submit",(function(t){t.preventDefault(),I.value&&(P.emit("chat message",I.value),I.value="")})),q.onclick=function(){I.value&&(P.emit("chat message",I.value),I.value="")};var M=document.getElementById("chat-messages");P.on("chat message",(function(t,e,n){var i=document.createElement("li"),r=document.createElement("span");if(r.className="chat-name",r.innerText=n,e){var o=document.createElement("img");o.className="chat-player-icon",o.src="./static/svg/ghost-solid.svg",o.alt="player-icon",o.title="対戦者",r.appendChild(o)}i.appendChild(r);var a=document.createElement("span");a.innerText=t,i.appendChild(a),M.appendChild(i),M.scrollTop=M.scrollHeight})),document.getElementById("info-icon").onclick=function(){document.getElementById("info-overlay").style.display="flex"},document.getElementById("close-icon").onclick=function(){document.getElementById("info-overlay").style.display="none"}})();