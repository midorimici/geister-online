(()=>{"use strict";const t="rgb(30, 30, 30)",e="rgb(200, 0, 0)",n="rgb(0, 0, 200)",i="rgb(150, 150, 150)";var r=function(){function t(t){this.v=t}return t.prototype.val=function(){return this.v},t.prototype.add=function(e){return Array.isArray(e)?new t([e[0]+this.v[0],e[1]+this.v[1]]):new t([e+this.v[0],e+this.v[1]])},t.prototype.mul=function(e){return new t([e*this.v[0],e*this.v[1]])},t.prototype.div=function(e){return new t([this.v[0]/e,this.v[1]/e])},t.prototype.quot=function(e){return new t([Math.floor(this.v[0]/e),Math.floor(this.v[1]/e)])},t}(),o=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return a},a=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(o(arguments[e]));return t},l=function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],i=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};const s=function(){function s(t,e){this.canvas=t,this.isEN=e,this.ctx=t.getContext("2d"),this.squareSize=3*t.width/20,this.margin=t.width/20,this.pieceSize=t.width/10,this.piecePath=new Path2D,this.piecePath.moveTo(0,-this.pieceSize/2),this.piecePath.lineTo(-this.pieceSize/2,this.pieceSize/2),this.piecePath.lineTo(this.pieceSize/2,this.pieceSize/2),this.piecePath.closePath(),this.arrowPath=new Path2D,this.arrowPath.moveTo(this.pieceSize/2,this.pieceSize/2),this.arrowPath.lineTo(0,0),this.arrowPath.lineTo(-this.pieceSize/2,this.pieceSize/2),this.arrowPath.moveTo(0,0),this.arrowPath.lineTo(0,this.pieceSize),this.arrowPath.closePath()}return s.prototype.clearCanvas=function(){this.ctx.fillStyle="rgb(240, 227, 206)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},s.prototype.waiting=function(e){this.clearCanvas();var n=this.canvas,i=this.ctx,r=n.width/20;i.fillStyle=t,i.font=r+"px Meiryo","player"===e?i.fillText(this.isEN?"Waiting for the opponent...":"対戦相手の入室を待っています...",n.width/2-7.5*r,n.height/2):i.fillText(this.isEN?"Waiting for players placing pieces...":"対戦者が駒を配置するのを待っています...",n.width/2-9.5*r,n.height/2)},s.prototype.waitingPlayer=function(){this.waiting("player")},s.prototype.waitingPlacing=function(){this.waiting("placing")},s.prototype.grid=function(e,n,i){var o=this.ctx,l=this.squareSize;o.strokeStyle=t,o.lineWidth=2,o.beginPath();for(var s=0;s<=i;s++)o.moveTo.apply(o,a(new r(e).add([0,l*s]).val())),o.lineTo.apply(o,a(new r(e).add([l*n,l*s]).val()));for(s=0;s<=n;s++)o.moveTo.apply(o,a(new r(e).add([l*s,0]).val())),o.lineTo.apply(o,a(new r(e).add([l*s,l*i]).val()));o.closePath(),o.stroke()},s.prototype.piece=function(t,e,n){var i=this.ctx,o=new r(e).mul(this.squareSize).add(this.margin+this.squareSize/2).val();i.save(),i.fillStyle=t,i.translate.apply(i,a(o)),n&&i.rotate(Math.PI),i.fill(this.piecePath),i.restore()},s.prototype.button=function(e,n,i){var o=this.ctx;o.fillStyle=i?"rgb(160, 140, 120)":"rgb(200, 180, 160)",o.fillRect.apply(o,a(e,n)),o.font=this.canvas.width/30+"px Meiryo",o.save(),o.textAlign="center",o.textBaseline="middle",o.fillStyle=t,o.fillText.apply(o,a(["OK"],new r(n).div(2).add(e).val())),o.restore()},s.prototype.decidePiecePlace=function(i,r){var a,s;this.clearCanvas();var c=this.ctx,u=this.canvas.width,h=u/40,d=this.isEN?"Decide the initial positions of your pieces. (↓ your side   ↑ opponent's side)":"駒の配置を決めてね（↓自分側　↑相手側）",p=this.isEN?"Click (tap) the pieces to swap bad ghosts (red) and good ghosts (blue).":"クリック（タップ）で悪いおばけ（赤）と良いおばけ（青）を切り替えるよ";c.fillStyle=t,c.font=h+"px Meiryo",c.fillText(d,u/30,u/30),c.fillText(p,u/30,u/30+2*h);var f=[this.margin+this.squareSize,this.margin+2*this.squareSize];this.grid(f,4,2),this.button([5*u/6,5*u/6],[u/8,u/12],r);try{for(var v=l(i.entries()),y=v.next();!y.done;y=v.next()){var g=o(y.value,2),m=g[0],w=g[1],S=o(m.split(","),2),P=S[0],x=S[1];this.piece("R"===w?e:n,[+P,+x],!1)}}catch(t){a={error:t}}finally{try{y&&!y.done&&(s=v.return)&&s.call(v)}finally{if(a)throw a.error}}},s.prototype.board=function(s,c,u,h,d){var p,f;void 0===d&&(d=!1),this.clearCanvas();var v=this.ctx;this.grid([this.margin,this.margin],6,6);var y=(this.squareSize-this.pieceSize)/2,g=new r([this.squareSize/2,y]).add(this.margin).val();v.save(),v.translate.apply(v,a(g)),v.stroke(this.arrowPath),v.restore(),v.save(),v.translate.apply(v,a(new r(g).add([5*this.squareSize,0]).val())),v.stroke(this.arrowPath),v.restore(),v.save(),v.translate.apply(v,a(new r(g).add([0,5*this.squareSize+this.pieceSize]).val())),v.rotate(Math.PI),v.stroke(this.arrowPath),v.restore(),v.save(),v.translate.apply(v,a(new r(g).add([5*this.squareSize,5*this.squareSize+this.pieceSize]).val())),v.rotate(Math.PI),v.stroke(this.arrowPath),v.restore();try{for(var m=l(s.entries()),w=m.next();!w.done;w=m.next()){var S=o(w.value,2),P=S[0],x=S[1],b="R"===x.color?e:n,z=P.split(",").map((function(t){return+t}));0===c?this.piece(d||0===x.turn?b:i,z,1===x.turn):this.piece(d||1===x.turn?b:i,z,0===x.turn)}}catch(t){p={error:t}}finally{try{w&&!w.done&&(f=m.return)&&f.call(m)}finally{if(p)throw p.error}}var E=this.canvas.width,T=E/40;v.fillStyle=t,v.font=T+"px Meiryo",v.fillText(1===c?h:u,3*E/4,E-T),v.fillText(1===c?u:h,3*E/4,T)},s.prototype.dest=function(t,e,n){var i,o,s=this.ctx;try{for(var c=l(t.coveringSquares(e)),u=c.next();!u.done;u=c.next()){var h=u.value;if(!n.has(String(h))||n.get(String(h)).turn!==n.get(String(e)).turn){var d=new r(h).mul(this.squareSize).add(this.margin+this.squareSize/2).val();s.beginPath(),s.arc.apply(s,a(d,[this.pieceSize/2,0,2*Math.PI])),s.fillStyle="rgb(121, 202, 68)",s.fill()}}}catch(t){i={error:t}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(i)throw i.error}}},s.prototype.takenPieces=function(t,i){for(var r=this,o=this.ctx,l=this.pieceSize/6,s=this.margin,c=this.squareSize,u=function(t,e){o.save(),o.fillStyle=e,o.translate.apply(o,a(t)),o.scale(1/6,1/6),o.fill(r.piecePath),o.restore()},h=0===i?s+6*c+l:l,d=1===i?s+6*c+l:l,p=0;p<t[0].R;p++)u([(p+1)*l,h],e);for(p=0;p<t[0].B;p++)u([(p+1+t[0].R)*l,h],n);for(p=0;p<t[1].R;p++)u([(p+1)*l,d],e);for(p=0;p<t[1].B;p++)u([(p+1+t[1].R)*l,d],n)},s}(),c=function(){function t(t){this.squareSize=3*t.width/20,this.margin=t.width/20}return t.prototype.getWindowPos=function(t){var e=t.target.getBoundingClientRect();return[t.clientX-e.left,t.clientY-e.top]},t.prototype.chcoord=function(t){return new r(t).add(-this.margin).quot(this.squareSize).val()},t.prototype.getCoord=function(t){return this.chcoord(this.getWindowPos(t))},t.prototype.onArea=function(t,e,n,i,r,o){return n<=t&&t<=n+r&&i<=e&&e<=i+o},t}();const u=function(){function t(t,e){this.color=t,this.turn=e}return t.prototype.coveringSquares=function(t){var e=[[0,1],[0,-1],[-1,0],[1,0]].map((function(e){return new r(t).add(e).val()})).filter((function(t){var e=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return a}(t,2),n=e[0],i=e[1];return 0<=n&&n<=5&&0<=i&&i<=5}));return"B"===this.color&&("0,0"===String(t)?e.push([0,-1]):"5,0"===String(t)&&e.push([5,-1])),e},t}();var h,d,p=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return a},f=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(p(arguments[e]));return t},v="/en/"===location.pathname,y=!1,g=document.getElementById("canvas"),m=document.getElementById("game-message"),w=document.getElementById("mute-icon"),S=!0,P=function(){document.getElementById("settings").style.display="none";var t=document.documentElement.clientWidth,e=document.documentElement.clientHeight;(t<e||e<720)&&(document.getElementById("logo").style.display="none",document.getElementById("info-icon").style.display="none",document.getElementsByTagName("footer")[0].style.display="none");var n=(.9*(t<e?t:e)).toString();g.setAttribute("width",n),g.setAttribute("height",n),h=new s(g,v),y=!0,document.getElementById("game-container").style.display="flex"},x=io("https://geister-online.herokuapp.com"),b=document.getElementById("form");b.addEventListener("submit",(function(t){t.preventDefault();var e=new FormData(b),n={roomId:e.get("room"),role:e.get("role"),name:""===e.get("username")?v?"anonymous":"名無し":e.get("username")};d=n.role,x.emit("enter room",n)}),!1),x.on("room full",(function(t){document.getElementById("message").innerText=v?"The room "+t+" is full. You cannot join in as a player.":"ルーム "+t+" はいっぱいです。対戦者として参加することはできません。"})),x.on("no room",(function(t){document.getElementById("message").innerText=v?"No player is present in the room "+t+".":"ルーム "+t+" では対戦が行われていません。"})),x.on("wait opponent",(function(){y||P(),h.waitingPlayer()}));for(var z,E=new Map,T=1;T<=4;T++)for(var k=2;k<=3;k++)E.set(T+","+k,"R");var B=function(t){new Audio("../static/sounds/"+t+".wav").play()};x.on("place pieces",(function(){y||P();var t=g.width,e=!1,n=function(){h.decidePiecePlace(E,!e)};n(),z=new c(g),g.onclick=function(i){for(var r=1;r<=4;r++)for(var o=2;o<=3;o++)String(z.getCoord(i))===String([r,o])&&(E.set(r+","+o,"R"===E.get(r+","+o)?"B":"R"),a=Array.from(E.values()),e=a.filter((function(t){return"R"===t})).length===a.filter((function(t){return"B"===t})).length,S||B("select"));var a;z.onArea.apply(z,f(z.getWindowPos(i),[5*t/6,5*t/6,t/8,t/12]))&&(e?(g.onclick=function(){},x.emit("decided place",f(E.entries())),S||B("decide")):S||B("forbid")),n()}})),x.on("wait placing",(function(){y||P(),h.waitingPlacing()})),x.on("game",(function(t,e,n,i,r,o){var a,l=new Map(t);h.board(l,e,i,r),h.takenPieces(o,e),n?(m.innerText=v?"It's your turn.":"あなたの番です。",S||B("move"),z=new c(g),g.onclick=function(t){var n=z.getCoord(t);if(l.has(String(n))&&l.get(String(n)).turn===e){a=n;var s=Object.values(l.get(String(n))),c=new(u.bind.apply(u,f([void 0],s)));h.board(l,e,i,r),h.dest(c,a,l),h.takenPieces(o,e)}else l.has(String(a))&&(s=Object.values(l.get(String(a))),(c=new(u.bind.apply(u,f([void 0],s)))).coveringSquares(a).some((function(t){return String(t)===String(n)}))&&(l.set(String(n),l.get(String(a))),l.delete(String(a)),S||B("move"),x.emit("move piece",e,a,n))),h.board(l,e,i,r),h.takenPieces(o,e),a=null}):(m.innerText=v?"It's your opponent's turn.":"相手の番です。",g.onclick=function(){})})),x.on("watch",(function(t,e,n,i,r){if("watch"===d){y||P();var o=new Map(t);h.board(o,0,e,n,!0),h.takenPieces(r,0);var a=0===i?e:n;m.innerText=v?"It's "+a+"'s turn.":a+" さんの番です。",S||B("move")}})),x.on("tell winner to audience and first",(function(t,e,n,i,r){m.innerText=v?t+" won!":t+" の勝ち！",S||B("win"),"play"===d&&(g.onclick=function(){h.board(new Map(e),0,n,i,!0),h.takenPieces(r,0),g.onclick=function(){}})})),x.on("tell winner to second",(function(t,e,n,i,r){m.innerText=v?t+" won!":t+" の勝ち！",S||B("win"),g.onclick=function(){h.board(new Map(e),1,n,i,!0),h.takenPieces(r,1),g.onclick=function(){}}})),x.on("player discon",(function(t){alert(v?t+"'s connection is closed.":t+" さんの接続が切れました。"),location.reload()})),w.onclick=function(){w.src=S?"../static/svg/volume-up-solid.svg":"../static/svg/volume-mute-solid.svg",w.title=S?v?"Mute":"ミュート":v?"Unmute":"ミュート解除",S=!S};var I=document.getElementById("chat-form"),q=document.getElementById("chat-input"),M=document.getElementById("chat-send-icon");I.addEventListener("submit",(function(t){t.preventDefault(),q.value&&(x.emit("chat message",q.value),q.value="")})),M.onclick=function(){q.value&&(x.emit("chat message",q.value),q.value="")};var C=document.getElementById("chat-messages");x.on("chat message",(function(t,e,n){var i=document.createElement("li"),r=document.createElement("span");if(r.className="chat-name",r.innerText=n,e){var o=document.createElement("img");o.className="chat-player-icon",o.src="../static/svg/ghost-solid.svg",o.alt="player-icon",o.title=v?"Player":"対戦者",r.appendChild(o)}i.appendChild(r);var a=document.createElement("span");a.innerText=t,i.appendChild(a),C.appendChild(i),C.scrollTop=C.scrollHeight})),document.getElementById("info-icon").onclick=function(){document.getElementById("info-overlay").style.display="flex"},document.getElementById("close-icon").onclick=function(){document.getElementById("info-overlay").style.display="none"}})();